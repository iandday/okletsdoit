{% extends "components/layout/base.html" %}

{% load static %}

{% block title %}
  {% if category %}
    {{ category.first.name }} Expenses
  {% else %}
    All Expenses
  {% endif %}
{% endblock title %}
{% block content %}
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="breadcrumbs mb-4">
      <ul>
        <li>
          <a href="{% url 'expenses:summary' %}" class="link">Expenses</a>
        </li>
        {% if category %}
          <li>
            <a href="{% url 'expenses:list' %}" class="link">All Expenses</a>
          </li>
          <li>{{ category.first.name }}</li>
        {% else %}
          <li>All Expenses</li>
        {% endif %}
      </ul>
    </div>
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
      <div>
        <h1 class="text-4xl font-bold text-base-content mb-2">
          {% if category %}
            {{ category.first.name }} Expenses
          {% else %}
            All Expenses
          {% endif %}
        </h1>
        <p class="text-md text-base-content/70">
          Expenses associated with a list are <span class="italic">italicized</span>.
        </p>
        <p class="text-sm text-base-content/70">
          The Estimated and Actual fields for associated items are calculated based on their respective list entries. Estimated will show the total of all items in the list, while Actual will only show the sum of items marked Purchased.
        </p>
      </div>
      <div class="flex gap-2">
        {% if category %}
          <a href="{% url 'expenses:list' %}" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
            All Expenses
          </a>
        {% endif %}
        <a href="{% url 'expenses:create' %}" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5"
               fill="none"
               viewBox="0 0 24 24"
               stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Add Expense
        </a>
      </div>
    </div>
    <!-- DataTable -->
    <div class="associated-card">
      <div class="card-body">
        <div class="overflow-x-auto">
          <table id="expensesTable" class="associated-table">
            <thead>
              <tr>
                <th class="associated-table-header">Item</th>
                <th class="associated-table-header">Category</th>
                <th class="associated-table-header">Date</th>
                <th class="associated-table-header">Estimated</th>
                <th class="associated-table-header">Actual</th>
                <th class="associated-table-header noExport">Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- populated by datatables script-->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Delete Expense Modal-->

  {% include "shared_helpers/modal/object_delete_shell.html" %}

{% endblock content %}
{% block extra_script %}
  <!-- datatables and optional scripts-->

  {% include "shared_helpers/script/datatables.html" %}

  <script nonce="{{ request.csp_nonce }}">
    $(document).ready(function() {
      const categorySlug = new URLSearchParams(window.location.search).get('category');
      let ajaxUrl = '{% url "expenses:expense_data" %}';
      if (categorySlug) {
        ajaxUrl += `?category=${categorySlug}`;
      }

      $('#expensesTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: ajaxUrl,
        order: [
          [0, 'asc']
        ],
        columns: [{
          data: 'item',
          name: 'item',

        }, {
          data: 'category',
          name: 'category',

        }, {
          data: 'date',
          render: function(data) {
            return data ? new Date(data).toLocaleDateString() : '<span class="text-base-content/50">-</span>';
          }
        }, {
          data: 'estimated_amount',
          render: function(data) {
            return data > 0 ? `$${data.toFixed(2)}` : '<span class="text-base-content/50">-</span>';
          }
        }, {
          data: 'actual_amount',
          render: function(data) {
            return data > 0 ? `$${data.toFixed(2)}` : '<span class="text-base-content/50">-</span>';
          }
        }, {
          data: 'menu_content',
          orderable: false,
          render: function(data) {
            return data;
          }
        }],
        pageLength: 25,
        responsive: true,
        fixedHeader: true,
        language: {
          search: "Search expenses:",
          lengthMenu: "Show _MENU_ expenses per page",
          info: "Showing _START_ to _END_ of _TOTAL_ expenses",
          infoEmpty: "No expenses found",
          infoFiltered: "(filtered from _MAX_ total expenses)",
          emptyTable: "No expenses available",
          zeroRecords: "No matching expenses found"
        },
        layout: {
          topStart: {
            search: {
              placeholder: 'Search'
            },
          },
          topEnd: 'buttons',
          bottomStart: {
            pageLength: {},
            paging: {}
          }
        },
        buttons: [{
          extend: 'searchBuilder',
          config: {
            columns: [0, 1, 3, 4],

          }
        }, {
          extend: 'copy',
          exportOptions: {
            columns: ':not(.noExport)'
          }
        }, {
          extend: 'excelHtml5',
          exportOptions: {
            columns: ':not(.noExport)'
          }
        }, {
          extend: 'pdfHtml5',
          exportOptions: {
            columns: ':not(.noExport)'
          }
        }, {
          extend: 'csvHtml5',
          exportOptions: {
            columns: ':not(.noExport)'
          }
        }],

        initComplete: function() {
          // Style the search input
          $('.dataTables_filter input').addClass('input input-bordered input-sm');
          $('.dataTables_filter label').addClass('flex items-center gap-2');

          // Style the length select
          $('.dataTables_length select').addClass('select select-bordered select-sm');
          $('.dataTables_length label').addClass('flex items-center gap-2');

          // Style pagination
          $('.dataTables_paginate .paginate_button').addClass('btn btn-sm');
          $('.dataTables_paginate .paginate_button.current').addClass('btn-primary');
        }
      });


    });
  </script>
  <!-- Delete Modal Functionality-->
  {% url "expenses:expense_delete_modal" as delete_modal_url %}

  {% include "shared_helpers/modal/object_delete_script.html" %}

{% endblock extra_script %}
