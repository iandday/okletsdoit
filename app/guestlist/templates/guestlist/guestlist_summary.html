{% extends "components/layout/base.html" %}

{% load static %}

{% block title %}
    Guest List Summary
{% endblock title %}
{% block content %}
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-base-content mb-2">Guest List Summary</h1>
                <p class="text-base-content/70">Total Guests: {{ total_guests }}</p>
                <p class="text-base-content/70">Invited</p>
                <div class="gap-2">
                    <div class="badge badge-secondary">{{ wedding_config.standard_group_label }}: {{ total_invited_standard }}</div>
                    <div class="badge badge-secondary">{{ wedding_config.vip_group_label }}: {{ total_invited_vip }}</div>
                    <div class="badge badge-secondary">Total: {{ total_invited }}</div>
                </div>
                <p class="text-base-content/70">Responses</p>
                <div class="gap-2">
                    <div class="badge badge-secondary">{{ wedding_config.standard_group_label }}: {{ total_attending_standard }}</div>
                    <div class="badge badge-secondary">{{ wedding_config.vip_group_label }}: {{ total_attending_vip }}</div>
                    <div class="badge badge-secondary">Confirmed Overnight: {{ total_attending_overnight }}</div>
                </div>
                <div class="gap-2">
                    <div class="badge badge-secondary">Total: {{ total_attending }}</div>
                    <div class="badge badge-secondary">Declined: {{ total_declined }}</div>
                    <div class="badge badge-secondary">Pending: {{ total_pending }}</div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-4 sm:mt-0">
                <a href="{% url 'guestlist:all_guests' %}"
                   class="btn btn-accent text-neutral-content">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    View All Guests
                </a>
                <a href="{% url 'guestlist:guestgroup_create' %}"
                   class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    New Guest Group
                </a>
                <button class="btn btn-secondary" id="import-modal-btn">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Import Guests
                </button>
                <a href="{% url 'guestlist:address_csv_export' %}"
                   class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5,9 C19.2238576,9 19,8.77614237 19,8.5 L19,7 L15.5,7 C15.2238576,7 15,6.77614237 15,6.5 L15,3 L6.5,3 C5.67157288,3 5,3.67157288 5,4.5 L5,19.5 C5,20.3284271 5.67157288,21 6.5,21 L17.5,21 C18.3284271,21 19,20.3284271 19,19.5 L19,17.5 C19,17.2238576 19.2238576,17 19.5,17 C19.7761424,17 20,17.2238576 20,17.5 L20,19.5 C20,20.8807119 18.8807119,22 17.5,22 L6.5,22 C5.11928813,22 4,20.8807119 4,19.5 L4,4.5 C4,3.11928813 5.11928813,2 6.5,2 L15.4720225,2 C15.6047688,1.99158053 15.7429463,2.03583949 15.8535534,2.14644661 L19.8535534,6.14644661 C19.9641605,6.25705373 20.0084195,6.39523125 20,6.52797748 L20,8.5 C20,8.77614237 19.7761424,9 19.5,9 Z M18.2928932,13 L10.4861218,13 C10.2099794,13 9.98612181,12.7761424 9.98612181,12.5 C9.98612181,12.2238576 10.2099794,12 10.4861218,12 L18.2928932,12 L16.1464466,9.85355339 C15.9511845,9.65829124 15.9511845,9.34170876 16.1464466,9.14644661 C16.3417088,8.95118446 16.6582912,8.95118446 16.8535534,9.14644661 L19.8535534,12.1464466 C20.0488155,12.3417088 20.0488155,12.6582912 19.8535534,12.8535534 L16.8535534,15.8535534 C16.6582912,16.0488155 16.3417088,16.0488155 16.1464466,15.8535534 C15.9511845,15.6582912 15.9511845,15.3417088 16.1464466,15.1464466 L18.2928932,13 Z M16,3.70710678 L16,6 L18.2928932,6 L16,3.70710678 Z" />
                    </svg>
                    Export Address Data
                </a>
            </div>
        </div>
        <!-- Guest Groups Grid -->
        {% if guest_groups %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for guest_group in guest_groups %}
                    {% if not guest_group.is_deleted %}
                        <div class="list-card">
                            <div class="card-body">
                                <div class="flex items-start justify-between mb-4">
                                    <a class="list-card-title"
                                       href="{% url 'guestlist:guestgroup_detail' guest_group.slug %}">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="h-5 w-5"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                        {{ guest_group.name }}
                                    </a>
                                    <!-- list card options menu-->
                                    {% url 'guestlist:guestgroup_detail' guest_group.slug as detail_action %}
                                    {% url 'guestlist:guestgroup_edit' guest_group.slug as update_action %}
                                    <c-object.menu slug="{{ guest_group.slug }}" />
                                </div>
                                <!-- Relationship Badge -->
                                <div class="mb-2">
                                    <div class="badge badge-secondary">{{ guest_group.associated_with.first_name }}</div>
                                    <div class="badge badge-primary">
                                        {% if guest_group.relationship == "Rel" %}
                                            Relative
                                        {% elif guest_group.relationship == "Fri" %}
                                            Friend
                                        {% elif guest_group.relationship == "Col" %}
                                            Colleague
                                        {% endif %}
                                    </div>
                                    {% if guest_group.priority == 3 %}
                                        <div class="badge badge-error">High Priority</div>
                                    {% elif guest_group.priority == 2 %}
                                        <div class="badge badge-warning">Medium Priority</div>
                                    {% else %}
                                        <div class="badge badge-info">Low Priority</div>
                                    {% endif %}
                                </div>
                                <!-- RSVP Stats -->
                                <div class="flex justify-center mb-4 gap-2">
                                    <div class="badge badge-neutral">Total: {{ guest_group.group_count }}</div>
                                    <div class="badge badge-neutral">Invited: {{ guest_group.group_invited_count }}</div>
                                </div>
                                <div class="flex justify-center mb-4 gap-2">
                                    <div class="badge badge-neutral">Attending: {{ guest_group.group_attending_count }}</div>
                                    <div class="badge badge-neutral">Overnight: {{ guest_group.group_overnight }}</div>
                                </div>
                                <!-- Contact Info -->
                                {% if guest_group.email or guest_group.phone %}
                                    <div class="text-sm  mb-4">
                                        {% if guest_group.email %}
                                            <div class="flex items-center gap-1">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     class="h-4 w-4"
                                                     fill="none"
                                                     viewBox="0 0 24 24"
                                                     stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                </svg>
                                                {{ guest_group.email }}
                                            </div>
                                        {% endif %}
                                        {% if guest_group.phone %}
                                            <div class="flex items-center gap-1">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     class="h-4 w-4"
                                                     fill="none"
                                                     viewBox="0 0 24 24"
                                                     stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                </svg>
                                                {{ guest_group.phone }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                <!-- Progress Bar -->
                                {% if guest_group.group_count > 0 %}
                                    {% widthratio guest_group.group_attending_count guest_group.group_count 100 as attendance_percentage %}
                                    <div class="mb-4">
                                        <div class="flex justify-between text-sm text-neutral-content mb-1">
                                            <span>RSVP Progress</span>
                                            <span>{{ guest_group.group_attending_count }}/{{ guest_group.group_count }}</span>
                                        </div>
                                        <progress class="progress progress-primary w-full"
                                                  value="{{ attendance_percentage }}"
                                                  max="100"></progress>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="h-4 w-4"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <span class="text-sm">No guests yet</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="hero min-h-96">
                <div class="hero-content text-center">
                    <div class="max-w-md">
                        <div class="mb-8">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-24 w-24 mx-auto text-base-content/30"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-base-content mb-4">No Guest Groups Found</h2>
                        <p class="text-base-content/70 mb-6">
                            Get started by creating your first guest group or importing guests from an Excel file.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-2 justify-center">
                            <a href="{% url 'guestlist:guestgroup_create' %}"
                               class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="h-5 w-5"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Create Guest Group
                            </a>
                            <button class="btn btn-secondary" id="empty-state-import-btn">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="h-5 w-5"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Import from Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <c-object.delete-modal />
        <!-- Import Modal -->
        <dialog id="import_modal" class="modal">
            <div class="modal-box">
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
                </form>
                <h3 class="text-lg font-bold mb-4">Import Guests from Excel</h3>
                <form method="post"
                      enctype="multipart/form-data"
                      action="{% url 'guestlist:guestlist_import' %}">
                    {% csrf_token %}
                    <div class="form-control w-full mb-4">
                        <label class="label">
                            <span class="label-text">Select Excel File</span>
                        </label>
                        {{ form.excel_file }}
                        <label class="label">
                            <span class="label-text-alt">Supported formats: .xlsx, .xls</span>
                        </label>
                    </div>
                    <div class="alert alert-info mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-sm">
                                Required columns: <strong>group_name</strong>, <strong>first_name</strong>, <strong>last_name</strong>
                            </p>
                            <p class="text-sm">
                                Optional columns: group_email, group_phone, relationship, priority, plus_one, is_invited, is_attending, guest_notes, response_notes
                            </p>
                        </div>
                    </div>
                    <div class="modal-action">
                        <a href="{% url 'guestlist:guestlist_import' %}" class="btn btn-ghost">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-4 w-4"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Download Template
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-4 w-4"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            Import Guests
                        </button>
                    </div>
                </form>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>
    </div>
{% endblock content %}
{% block extra_script %}
    <script nonce="{{ request.csp_nonce }}">
      document.addEventListener('DOMContentLoaded', function() {
        // Modal handling
        const importModalBtn = document.getElementById('import-modal-btn');
        const emptyStateImportBtn = document.getElementById('empty-state-import-btn');
        const importModal = document.getElementById('import_modal');

        if (importModalBtn && importModal) {
          importModalBtn.addEventListener('click', function() {
            importModal.showModal();
          });
        }

        if (emptyStateImportBtn && importModal) {
          emptyStateImportBtn.addEventListener('click', function() {
            importModal.showModal();
          });
        }

        // File input validation
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) {
          fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
              const allowedExtensions = ['.xlsx', '.xls'];
              const fileName = file.name.toLowerCase();
              const isValidFile = allowedExtensions.some(ext => fileName.endsWith(ext));

              if (!isValidFile) {
                alert('Please select a valid Excel file (.xlsx or .xls)');
                this.value = '';
              }
            }
          });
        }
      });
    </script>
    <c-object.delete-script />
{% endblock extra_script %}
