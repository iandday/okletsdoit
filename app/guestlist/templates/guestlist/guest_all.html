{% extends "components/layout/base.html" %}

{% load static %}

{% block title %}
    {% if group %}
        {{ group.name }} Guests
    {% else %}
        All Guests
    {% endif %}
{% endblock title %}
{% block content %}
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="breadcrumbs mb-4">
            <ul>
                <li>
                    <a href="{% url 'guestlist:guestlist_summary' %}"
                       class="link link-hover">Guest List</a>
                </li>
                {% if group %}
                    <li>
                        <a href="{% url 'guestlist:guestgroup_detail' group.slug %}"
                           class="link link-hover">{{ group.name }}</a>
                    </li>
                {% endif %}
                <li class="text-base-content">All Guests</li>
            </ul>
        </div>
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-bold text-base-content mb-2">
                    {% if group %}
                        {{ group.name }} Guests
                    {% else %}
                        All Guests
                    {% endif %}
                </h1>
            </div>
            <div class="flex gap-2">
                <a href="{% url 'guestlist:guestlist_summary' %}"
                   class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Summary
                </a>
                <a href="{% url 'guestlist:guest_create' %}" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Add Guest
                </a>
            </div>
        </div>
        <!-- Summary Badges -->
        <div class="flex flex-col sm:flex-row gap-4">
            <p class="text-base-content/70">Invited</p>
            <div class="gap-2">
                <div class="badge badge-secondary">Day: {{ total_invited_day }}</div>
                <div class="badge badge-secondary">Overnight: {{ total_invited_overnight }}</div>
                <div class="badge badge-secondary">Total: {{ total_invited }}</div>
            </div>
            <p class="text-base-content/70">Responses</p>
            <div class="gap-2">
                <div class="badge badge-secondary">Day: {{ total_attending_day }}</div>
                <div class="badge badge-secondary">Overnight: {{ total_attending_overnight }}</div>
                <div class="badge badge-secondary">Total: {{ total_attending }}</div>
                <div class="badge badge-secondary">Declined: {{ total_declined }}</div>
                <div class="badge badge-secondary">Pending: {{ total_pending }}</div>
            </div>
        </div>
    </div>
    <!-- DataTable -->
    {% if guests %}
        <div class="associated-card">
            <div class="associated-card-body">
                <div class="overflow-x-auto">
                    <table id="guestsTable" class="associated-table">
                        <thead>
                            <tr>
                                <th class="associated-table-header">First Name</th>
                                <th class="associated-table-header">Last Name</th>
                                <th class="associated-table-header">Group</th>
                                <th class="associated-table-header">Relationship</th>
                                <th class="associated-table-header">Plus One</th>
                                <th class="associated-table-header">Overnight</th>
                                <th class="associated-table-header">RSVP</th>
                                <th class="associated-table-header">Association</th>
                                <th class="associated-table-header noExport">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- populated by datatables -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="hero min-h-96">
            <div class="hero-content text-center">
                <div class="max-w-md">
                    <div class="mb-8">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-24 w-24 mx-auto text-base-content/30"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-base-content mb-4">No Guests Found</h2>
                    <p class="text-base-content/70 mb-6">
                        There are no guests in your guest list. Start by creating a guest group or adding individual guests.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-2 justify-center">
                        <a href="{% url 'guestlist:guestgroup_create' %}"
                           class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-5 w-5"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Create Guest Group
                        </a>
                        <a href="{% url 'guestlist:guest_create' %}" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-5 w-5"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                            </svg>
                            Add Individual Guest
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    <!-- Delete Deadline Modal-->

    {% include "shared_helpers/modal/object_delete_shell.html" %}

</div>
{% endblock content %}
{% block extra_script %}
    <!-- datatables and optional scripts-->

    {% include "shared_helpers/script/datatables.html" %}

    <script nonce="{{ request.csp_nonce }}">
      $(document).ready(function() {
        const listSlug = new URLSearchParams(window.location.search).get('list');
        let ajaxUrl = '{% url "guestlist:guest_data" %}';

        if (listSlug) {
          ajaxUrl += `?list=${listSlug}`;
        }

        $('#guestsTable').DataTable({
          processing: true,
          serverSide: true,
          ajax: ajaxUrl,
          order: [
            [2, 'asc']
          ],
          columns: [{
            data: 'first_name',
            name: 'first_name',
            render: function(data, type, row) {
              return `<div class="font-semibold">${data}</div>`;
            }
          }, {
            data: 'last_name',
            name: 'last_name',
            render: function(data, type, row) {
              return `<div class="font-semibold">${data}</div>`;
            }
          }, {
            data: 'group',
            name: 'group',

          }, {
            data: 'relationship',
            name: 'relationship',

          }, {
            data: 'plus_one',
            name: 'plus_one',

          }, {
            data: 'overnight',
            name: 'overnight',

          }, {
            data: 'rsvp',
            name: 'rsvp',

          }, {
            data: 'association',
            name: 'association',

          }, {
            data: 'menu_content',
            name: 'menu_content',
            orderable: false,
            render: function(data) {
              return data;
            }
          }],
          pageLength: 25,
          responsive: true,
          fixedHeader: true,
          language: {
            search: "Search Guests:",
            lengthMenu: "Show _MENU_ guests per page",
            info: "Showing _START_ to _END_ of _TOTAL_ guests",
            infoEmpty: "No guests found",
            infoFiltered: "(filtered from _MAX_ total guests)",
            emptyTable: "No guests available",
            zeroRecords: "No matching guests found"
          },
          layout: {
            topStart: {
              search: {
                placeholder: 'Search'
              },
            },
            topEnd: 'buttons',
            bottomStart: {
              pageLength: {},
              paging: {}
            }
          },
          buttons: [{
            extend: 'searchBuilder',
            config: {
              columns: [0, 1, 3, 4],

            }
          }, {
            extend: 'copy',
            exportOptions: {
              columns: ':not(.noExport)'
            }
          }, {
            extend: 'excelHtml5',
            exportOptions: {
              columns: ':not(.noExport)'
            }
          }, {
            extend: 'pdfHtml5',
            exportOptions: {
              columns: ':not(.noExport)'
            }
          }, {
            extend: 'csvHtml5',
            exportOptions: {
              columns: ':not(.noExport)'
            }
          }],

          initComplete: function() {
            // Style the search input
            $('.dataTables_filter input').addClass('input input-bordered input-sm');
            $('.dataTables_filter label').addClass('flex items-center gap-2');

            // Style the length select
            $('.dataTables_length select').addClass('select select-bordered select-sm');
            $('.dataTables_length label').addClass('flex items-center gap-2');

            // Style pagination
            $('.dataTables_paginate .paginate_button').addClass('btn btn-sm');
            $('.dataTables_paginate .paginate_button.current').addClass('btn-primary');
          }
        });
      });
    </script>
    <!-- Delete Modal Functionality-->
    {% url "guestlist:guest_delete_modal" as delete_modal_url %}

    {% include "shared_helpers/modal/object_delete_script.html" %}

{% endblock extra_script %}
