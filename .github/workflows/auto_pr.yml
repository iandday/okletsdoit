name: Auto PR

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get branch and commit info
        id: branch_info
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Get commit count since branching from main
          COMMIT_COUNT=$(git rev-list --count origin/main..HEAD)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          # Get latest commit message
          LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          # Get all commits since branching
          COMMITS=$(git log origin/main..HEAD --pretty=format:"- %h %s (%an)" | head -20)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Generate PR title based on branch name
          # Convert branch-name to Title Case
          TITLE=$(echo "$BRANCH_NAME" | sed -e 's/-/ /g' -e 's/\b\(.\)/\u\1/g')
          # Check for conventional commit prefixes
          if [[ "$LATEST_COMMIT" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.*\))?:(.+)$ ]]; then
            TYPE="${BASH_REMATCH[1]}"
            SCOPE="${BASH_REMATCH[2]}"
            DESC="${BASH_REMATCH[3]}"
            case $TYPE in
              feat) EMOJI="âœ¨" ;;
              fix) EMOJI="ðŸ›" ;;
              docs) EMOJI="ðŸ“š" ;;
              style) EMOJI="ðŸ’„" ;;
              refactor) EMOJI="â™»ï¸" ;;
              perf) EMOJI="âš¡" ;;
              test) EMOJI="âœ…" ;;
              build) EMOJI="ðŸ—ï¸" ;;
              ci) EMOJI="ðŸ‘·" ;;
              chore) EMOJI="ðŸ”§" ;;
              *) EMOJI="ðŸš€" ;;
            esac
            TITLE="$EMOJI $TYPE$SCOPE:$DESC"
          else
            TITLE="ðŸš€ $TITLE"
          fi
          echo "pr_title=$TITLE" >> $GITHUB_OUTPUT

      - name: Generate PR description
        id: pr_body
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > pr_body.md << EOF
          ## Summary
          
          This PR contains changes from the \`${{ steps.branch_info.outputs.branch_name }}\` branch.
          
          **Latest commit:** ${{ steps.branch_info.outputs.latest_commit }}
          
          ## Changes
          
          ${{ steps.branch_info.outputs.commits }}
          
          ## Stats
          
          - **Total commits:** ${{ steps.branch_info.outputs.commit_count }}
          - **Branch:** \`${{ steps.branch_info.outputs.branch_name }}\`
          - **Base:** \`main\`
          - **Last updated:** ${TIMESTAMP}
          
          ---
          
          <sub>ðŸ¤– This PR was automatically created/updated by GitHub Actions</sub>
          EOF
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat pr_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update Pull Request
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: ${{ steps.branch_info.outputs.branch_name }}
          destination_branch: main
          pr_title: ${{ steps.branch_info.outputs.pr_title }}
          pr_body: ${{ steps.pr_body.outputs.body }}
          pr_label: auto-pr
          pr_draft: false
          pr_allow_empty: false
