name: Generate Pull Requests

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get branch and commit info
        id: branch_info
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          
          # Determine base branch based on current branch
          if [ "$BRANCH_NAME" = "develop" ]; then
            BASE_BRANCH="main"
          else
            BASE_BRANCH="develop"
          fi
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          
          # Get commit count since branching from base
          COMMIT_COUNT=$(git rev-list --count origin/$BASE_BRANCH..HEAD)
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          
          # Get latest commit message
          LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          # Get all commits since branching from base
          COMMITS=$(git log origin/$BASE_BRANCH..HEAD --pretty=format:"- %h %s (%an)" | head -20)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Generate PR title based on branch name
          # Convert branch-name to Title Case
          TITLE=$(echo "$BRANCH_NAME" | sed -e 's/-/ /g' -e 's/\b\(.\)/\u\1/g')
          # Check for conventional commit prefixes
          if [[ "$LATEST_COMMIT" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.*\))?:(.+)$ ]]; then
            TYPE="${BASH_REMATCH[1]}"
            SCOPE="${BASH_REMATCH[2]}"
            DESC="${BASH_REMATCH[3]}"
            case $TYPE in
              feat) EMOJI="âœ¨" ;;
              fix) EMOJI="ðŸ›" ;;
              docs) EMOJI="ðŸ“š" ;;
              style) EMOJI="ðŸ’„" ;;
              refactor) EMOJI="â™»ï¸" ;;
              perf) EMOJI="âš¡" ;;
              test) EMOJI="âœ…" ;;
              build) EMOJI="ðŸ—ï¸" ;;
              ci) EMOJI="ðŸ‘·" ;;
              chore) EMOJI="ðŸ”§" ;;
              *) EMOJI="ðŸš€" ;;
            esac
            TITLE="$EMOJI $TYPE$SCOPE:$DESC"
          else
            TITLE="ðŸš€ $TITLE"
          fi
          echo "pr_title=$TITLE" >> $GITHUB_OUTPUT

      - name: Generate PR description
        id: pr_body
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > pr_body.md << EOF
          ## Summary
          
          This PR contains changes from the \`${{ steps.branch_info.outputs.branch_name }}\` branch.
          
          **Latest commit:** ${{ steps.branch_info.outputs.latest_commit }}
          
          ## Changes
          
          ${{ steps.branch_info.outputs.commits }}
          
          ## Stats
          
          - **Total commits:** ${{ steps.branch_info.outputs.commit_count }}
          - **Branch:** \`${{ steps.branch_info.outputs.branch_name }}\`
          - **Base:** \`${{ steps.branch_info.outputs.base_branch }}\`
          - **Last updated:** ${TIMESTAMP}
          
          ---
          
          <sub>ðŸ¤– This PR was automatically created/updated by GitHub Actions</sub>
          EOF
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat pr_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update Pull Request
        uses: actions/github-script@v7
        env:
          PR_BODY: ${{ steps.pr_body.outputs.body }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ steps.branch_info.outputs.branch_name }}';
            const baseBranch = '${{ steps.branch_info.outputs.base_branch }}';
            const prTitle = '${{ steps.branch_info.outputs.pr_title }}';
            const prBody = process.env.PR_BODY;
            
            // Check if PR already exists
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              base: baseBranch,
              state: 'open'
            });
            
            if (pulls.length > 0) {
              // Update existing PR
              const pr = pulls[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: prTitle,
                body: prBody
              });
              console.log(`Updated PR #${pr.number}`);
            } else {
              // Create new PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: branchName,
                base: baseBranch,
                body: prBody
              });
              
              // Add label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['auto-pr']
              });
              
              console.log(`Created PR #${pr.number}`);
            }
